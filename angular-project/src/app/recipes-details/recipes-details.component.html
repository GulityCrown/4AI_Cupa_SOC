<!-- Overall Page Container -->
<div class="container">

  <!-- Edit Form View (Conditional) -->
  <ng-container *ngIf="clicked == true; else noCourses">
    <div class="inside_container">
      <h1 class="form-title">Uprava receptu</h1>
      <form class="edit_form" [formGroup]="profileForm">
        <!-- Recipe Name -->
        <mat-form-field appearance="outline">
          <mat-label>Názov</mat-label>
          <input matInput id="name" type="text" formControlName="name">
        </mat-form-field>

        <!-- Ingredients -->
        <mat-form-field appearance="outline">
          <mat-label>Ingrediencie</mat-label>
          <textarea matInput id="ingrediencie" formControlName="ingrediencie" rows="3"></textarea>
        </mat-form-field>
        <!-- Time (cas) -->
        <mat-form-field appearance="outline">
          <mat-label>Čas (min)</mat-label>
          <input matInput id="cas" type="number" formControlName="cas">
        </mat-form-field>

        <!-- Submit and Cancel Buttons -->
        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="submit()">Uložiť</button>
          <button mat-stroked-button color="warn" [routerLink]="['/RecipesDetails']">Zrušiť</button> <!-- Adjust route if needed -->
        </div>
      </form>
    </div>
  </ng-container>

  <!-- Recipe Details View (Conditional) -->
  <ng-template #noCourses>

    <!-- Recipe Details Wrapper (Gets the shadow) -->
    <div class="recipe-details-wrapper">
      <div class="recipe-container"> <!-- Content Centering/Layout -->
        <mat-card class="recipe-card"> <!-- Angular Material Card Structure -->
          <!-- Recipe Header -->
          <div class="recipe-header">
            <h1 class="recipe-title">{{this.recipe()?.name}}</h1> <!-- Added safe navigation operator -->
            <div class="recipe-meta">
              <div class="time-difficulty">
                <span class="time"><mat-icon>query_builder</mat-icon> {{this.recipe()?.cas}} min</span> <!-- Added safe navigation operator -->
                <span class="difficulty">Náročnosť: {{this.recipe()?.difficulty}}</span> <!-- Added safe navigation operator -->
              </div>
              <div class="recipe-actions">
                <div *ngIf="recipeService?.chRecipe?.checkID == recipeService?.chRecipe?.userID"> <!-- Added safe navigation operator -->
                  <button mat-icon-button (click)="edit()" matTooltip="Upraviť">
                    <mat-icon>edit</mat-icon>
                  </button>
                </div>
                <button mat-icon-button [routerLink]="['/PrintPage', recipe()?.id]" matTooltip="Tlačiť"> <!-- Added safe navigation operator -->
                  <mat-icon>print</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <!-- Recipe Image -->
          <div class="recipe-image-container">
            <img class="recipe-image" [src]="this.showImage()" alt="{{this.recipe()?.name}}"/> <!-- Added safe navigation operator -->
          </div>

          <!-- Recipe Content Tabs -->
          <div class="recipe-content-tabs">
            <mat-tab-group animationDuration="0ms">

              <!-- Tab 1: Postup (Instructions) -->
              <mat-tab label="Postup">
                <div class="tab-content-padding">
                   <ol class="instructions">
                      <li *ngFor="let postup of recipe()?.postupicky">{{ postup }}</li> <!-- Added safe navigation operator -->
                   </ol>
                </div>
              </mat-tab>

              <!-- Tab 2: Ingrediencie -->
              <mat-tab label="Ingrediencie">
                 <div class="tab-content-padding">
                    <table class="ingredients-table">
                      <tbody>
                         <!-- Added check for recipe().ingrediencie before splitting -->
                        <tr *ngFor="let ingredient of recipe()?.ingrediencie?.split(',')"> <!-- Added safe navigation operator -->
                          <td>{{ingredient}}</td>
                        </tr>
                      </tbody>
                    </table>
                 </div>
              </mat-tab>

              <!-- Tab 3: Výživové hodnoty -->
              <mat-tab label="Výživové hodnoty">
                 <div class="tab-content-padding">
                    <table class="nutrition-table">
                      <thead style="background-color: blue;">
                        <tr><th>Obsah jedla</th><th>Hodnoty</th></tr>
                      </thead>
                      <tbody>
                        <tr><td>Tuky</td><td>{{this.recipe()?.tuky}} g</td></tr> <!-- Added safe navigation operator -->
                        <tr><td>Cukor</td><td>{{this.recipe()?.cukor}} g</td></tr> <!-- Added safe navigation operator -->
                        <tr><td>Sacharidy</td><td>{{this.recipe()?.sacharidy}} g</td></tr> <!-- Added safe navigation operator -->
                        <tr><td>Bielkoviny</td><td>{{this.recipe()?.bielkoviny}} g</td></tr> <!-- Added safe navigation operator -->
                        <tr><td>Kalórie</td><td>{{this.recipe()?.kalorie}} kCal</td></tr> <!-- Added safe navigation operator -->
                        <tr><td>Gramáž</td><td>{{this.recipe()?.gramaz}} g</td></tr> <!-- Added safe navigation operator -->
                      </tbody>
                    </table>
                 </div>
              </mat-tab>

            </mat-tab-group>
          </div>

          <!-- Recipe Footer -->
          <div class="recipe-footer">
            <button mat-raised-button [routerLink]="['/Recipes']">Späť na recepty</button>
            <div *ngIf="recipeService?.chRecipe?.checkID == recipeService?.chRecipe?.userID || recipeService?.chRecipe?.admin == true"> <!-- Added safe navigation operator -->
              <button mat-icon-button color="warn" (click)="deleteBtn()" matTooltip="Vymazať recept">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </div>
        </mat-card>
      </div>
    </div> <!-- End recipe-details-wrapper -->


    <!-- Comments Section Wrapper (Gets the shadow) -->
    <div class="comments-section-wrapper">
      <div class="comments-container"> <!-- Content Centering/Layout -->
        <h2 class="comments-title">Komentáre</h2>

        <div class="comment-form">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Pridať komentár</mat-label>
            <textarea matInput id="koment" name="komentar" rows="3"></textarea> <!-- Consider using [(ngModel)] or formControl for the comment input -->
          </mat-form-field>
          <button mat-raised-button color="primary" (click)="addComment()">Odoslať</button>
        </div>

        <div class="comments-list">
          <!-- Loop through comments -->
           <!-- Added safe navigation operator to recensions() call -->
          <div *ngFor="let recension of recensions?.(); let i = index" class="comment-card">
            <div class="comment-header">
               <!-- Added safe navigation operator -->
              <a [routerLink]="['/userProfile', recension?.userName]" class="comment-author">
                <h3>{{recension?.profileName}}</h3> <!-- Added safe navigation operator -->
              </a>
               <!-- Added safe navigation operator -->
              <span class="comment-date">{{recension?.datetime | date:'medium'}}</span>
            </div>
            <div class="comment-content">
              <p>{{recension?.content}}</p> <!-- Added safe navigation operator -->
            </div>
            <div class="comment-footer">
               <!-- Actions shown only to owner/admin -->
                <!-- Added safe navigation operator -->
               <div class="comment-actions" *ngIf="recension?.userID == recension?.checkID || recipeService?.chRecipe?.admin == true">
                 <button mat-icon-button color="warn" (click)="Vymaz(recension?.id)" matTooltip="Vymazať komentár"> <!-- Added safe navigation operator -->
                    <mat-icon>delete</mat-icon>
                 </button>
               </div>
               <!-- Spacer -->
                <!-- Added safe navigation operator -->
               <div class="comment-footer-spacer" *ngIf="!(recension?.userID == recension?.checkID || recipeService?.chRecipe?.admin == true)"></div>
               <!-- Votes -->
               <div class="comment-votes">
                  <!-- Added safe navigation operator -->
                 <button mat-icon-button (click)="likeRecension(recension?.id)" matTooltip="Páči sa mi">
                   <mat-icon>thumb_up</mat-icon>
                   <span class="vote-count">{{recension?.amountOfLikes}}</span> <!-- Added safe navigation operator -->
                 </button>
                  <!-- Added safe navigation operator -->
                 <button mat-icon-button (click)="disslikeRecension(recension?.id)" matTooltip="Nepáči sa mi">
                   <mat-icon>thumb_down</mat-icon>
                   <span class="vote-count">{{recension?.amountOfDisslikes}}</span> <!-- Added safe navigation operator -->
                 </button>
               </div>
            </div>
          </div>
          <!-- End loop -->

           <!-- Placeholder if no comments -->
            <!-- Added safe navigation operator -->
           <div *ngIf="!recensions?.() || recensions?.()?.length === 0" class="no-comments">
              <p>Zatiaľ žiadne komentáre.</p>
           </div>

        </div>
      </div>
    </div> <!-- End comments-section-wrapper -->

  </ng-template> <!-- End #noCourses -->

</div> <!-- End .container -->